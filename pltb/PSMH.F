      SUBROUTINE PSMH(IRC,ICOUNT,K2CT,LCT,XP,YP,AGLMT1,AGLMT2,
     $IEC,IRD,ISV,XG,YG,CSPJ,SNPJ,XCM,YCM,XNKSV1,YNKSV1,NOUT1,NOUT2)
	INCLUDE 'COMA.FOR'
      DIMENSION LCT(16)
      DATA PIO2/1.5707963267949D0/
      DATA PI/3.1415926535898D0/
      DATA ANG/6.29D0/
	DATA ERLT/1.D-13/
  193 FORMAT (3F12.5,I5)
C
C     The intersection points have now been located
C***************************************************************
C     PLOT THE SMALL THETA HORIZON POINTS
C***************************************************************
C
      DO 320 J=1,IRC
      IF (ICOUNT.EQ.2) GO TO 209      
      IF (LCT(11).NE.1) GO TO 320     
C     ECLIPSING STAR    
      YP=YR(J)   
      XP=XR(J)   
      X=XP
      Y=YP
      IF (LCT(15).EQ.1) GO TO 75      
      Y=XP*CSPJ-YP*SNPJ
      X=XP*SNPJ+YP*CSPJ
      GO TO 306  
   75 CONTINUE   
      X=XP
      Y=YP
      GO TO 306  
C     ECLIPSED STAR     
  209 IF (LCT(3).NE.1) GO TO 320      
C     If AGLMT1 and AGLMT2.EQ.(-ANG),the eclipsed star is
C     not visible,in toto.
      IF ((DABS(AGLMT1+ANG).LE.ERLT).AND.(DABS(AGLMT2+ANG).LE.ERLT)) 
     $GO TO 320   
      YP=YR(J)   
      XP=XR(J)   
      X=XP
      Y=YP
      IF (LCT(5).EQ.1) GO TO 307      
      IF (ISV.EQ.IEC) GO TO 270
C  Following section follows procedure in SRT RANGE
      RDS=DSQRT(X**2+Y**2)      
      ANGLE=0.0D0
      IF ((X.GE.0.0D0).AND.(DABS(Y).LE.ERLT)) ANGLE=PIO2
      IF (DABS(ANGLE-PIO2).LE.ERLT) GO TO 1036
      IF ((X.LT.0.0D0).AND.(DABS(Y).LE.ERLT)) ANGLE=-PIO2
      IF (DABS(ANGLE+PIO2).LE.ERLT) GO TO 1036
 1017 ANGLE=DACOS(Y/RDS)
      IF (IRD.EQ.-1) ANGLE=PI-ANGLE
      IF (X.LT.0.0D0) ANGLE=-ANGLE
 1036 CONTINUE
C     IF AGLMT1 AND AGLMT2 ARE ON THE SMALL THETA BRANCH,PLOT ALL
C     POINTS ON THE LARGE THETA BRANCH
C     NOTE THAT ANGLE MOVES TOWARD MORE POSITIVE ANGLES ON THE LARGE     
C     THETA BRANCH      
C     If AGLMT1.EQ.ANG,plot all points
      IF (DABS(AGLMT1-ANG).LE.ERLT) GO TO 307
      IF ((AGLMT1.GE.0.0D0).AND.(AGLMT2.GE.0.0D0)) GO TO 304
      IF ((AGLMT1.LT.0.0D0).AND.(AGLMT2.LT.0.0D0)) GO TO 305
      IF ((AGLMT2.LT.0.0D0).AND.(AGLMT1.GE.0.0D0)) GO TO 309
      IF ((AGLMT2.GE.0.0D0).AND.(AGLMT1.LT.0.0D0)) GO TO 312
      CALL PMDSTOP      
  304 IF ((ANGLE.GE.AGLMT1).AND.(ANGLE.LE.AGLMT2)) GO TO 307      
      GO TO 320  
C     IF THE POINT FALLS BETWEEN AGLMT1 AND AGLMT2,PLOT IT 
  305 IF ((ANGLE.GT.AGLMT2).AND.(ANGLE.LT.AGLMT1)) GO TO 320      
      GO TO 307  
  309 IF (DABS(AGLMT2).LT.PIO2) GO TO 311
      IF ((ANGLE.LE.AGLMT1).AND.(ANGLE.GE.AGLMT2)) GO TO 307      
      GO TO 320  
  311 IF ((ANGLE.GE.AGLMT2).AND.(ANGLE.LE.AGLMT1)) GO TO 307
      GO TO 320
  312 IF (DABS(AGLMT1).GT.PIO2) GO TO 313
      IF ((ANGLE.GE.AGLMT1).AND.(ANGLE.LE.AGLMT2)) GO TO 307
      GO TO 320
  313 IF ((ANGLE.GE.AGLMT1).AND.(ANGLE.LE.AGLMT2)) GO TO 307
      GO TO 320
C     IF WE ARRIVE HERE,THE ECLIPSED STAR IS CENTERED AT YG,XG    
  270 A=X+XG     
      B=Y+YG     
      RDS=DSQRT(A**2+B**2)      
      ANGLE=0.0D0
      IF ((A.GE.0.0D0).AND.(DABS(B).LE.ERLT)) ANGLE=PIO2
      IF (DABS(DABS(ANGLE)-PIO2).LE.ERLT) GO TO 1336
      IF ((A.LT.0.0D0).AND.(DABS(B).LE.ERLT)) ANGLE=-PIO2
      IF (DABS(ANGLE+PIO2).LE.ERLT) GO TO 1336
 1317 ANGLE=DACOS(B/RDS)
      IF (IRD.EQ.-1) ANGLE=PI-ANGLE
      IF (A.LT.1.0D-4) ANGLE=-ANGLE
 1336 IF ((DABS(AGLMT1-ANG).LE.ERLT).AND.(DABS(AGLMT2-ANG).LE.ERLT)) 
     $GO TO 307   
      IF ((AGLMT1.GE.0.0D0).AND.(AGLMT2.GE.0.0D0)) GO TO 272
      IF ((AGLMT1.LT.0.0D0).AND.(AGLMT2.LT.0.0D0)) GO TO 273
      IF ((AGLMT2.LT.0.0D0).AND.(AGLMT1.GE.0.0D0)) GO TO 274
      IF ((AGLMT2.GE.0.0D0).AND.(AGLMT1.LT.0.0D0)) GO TO 275
      CALL PMDSTOP      
  272 IF ((ANGLE.GE.AGLMT1).AND.(ANGLE.LE.AGLMT2)) GO TO 307      
      GO TO 320  
  273 IF ((ANGLE.LT.AGLMT1).AND.(ANGLE.GT.AGLMT2)) GO TO 320      
      GO TO 307  
  274 IF (AGLMT2.GT.-PIO2) GO TO 276  
      IF ((ANGLE.LE.AGLMT1).AND.(ANGLE.GE.AGLMT2)) GO TO 307
      GO TO 320
  276 IF ((ANGLE.GE.AGLMT2).AND.(ANGLE.LE.AGLMT1)) GO TO 307 
      GO TO 320  
  275 IF (AGLMT2.GT.PIO2) GO TO 278   
      IF ((ANGLE.LT.AGLMT2).AND.(ANGLE.GT.AGLMT1)) GO TO 320      
      GO TO 307  
  278 IF ((ANGLE.GE.AGLMT1).AND.(ANGLE.LE.AGLMT2)) GO TO 307      
      GO TO 320  
  307 IF (LCT(15).EQ.1) GO TO 76      
      Y=XP*CSPJ-YP*SNPJ
      X=XP*SNPJ+YP*CSPJ
      GO TO 306  
   76 CONTINUE   
      X=XP
      Y=YP
  306 CONTINUE
      WRITE (NOUT2, 193) X-XCM, -Y+YCM ,1.D0, 0
	K2CT=K2CT+1
      IF (ICOUNT.EQ.2) GO TO 320
      IF (J.NE.(IRC-1)) GO TO 320
      XNKSV1=X
      YNKSV1=Y
  320 CONTINUE
      RETURN
      END
