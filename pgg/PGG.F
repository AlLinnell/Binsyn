      PROGRAM PGG
      INCLUDE 'COMA.FOR'
      INCLUDE 'COMM.FOR'
      INCLUDE 'COMR.FOR'
      DIMENSION PHS(300),SMVI(300),DMVI(300),SMPT1(300),DMPT1(300),
     $SMPT2(300),DMPT2(300),SMQ(300),DMQ(300),DMOM(300),SMOM(300),
     $SMECC(300),DMECC(300),SMTE1(300),DMTE1(300),SMTE2(300),
     $DMTE2(300),SMA1(300),DMA1(300),SMA2(300),DMA2(300),SMBCF1(300),
     $DMB1(300),SMBCF2(300),DMB2(300),PHSIV(300)
      DIMENSION UC(2),C1(2),C2(2),T0(2),A(2),BCF(2),UA(2),TE(2)
      DIMENSION FL1(9)
      COMMON /NUNIT/ NU, NUOUT, IFOUT
      CHARACTER * 7 LABEL
      CHARACTER * 36 FL1
      CHARACTER * 10 DATE,TIME,ZONE
	INTEGER * 2 IYR,IMON,IDAY,IHR,IMIN,ISEC,I100TH
      DIMENSION TIMEVALUES(8)
      INTEGER :: CLOCK1,CLOCK2,COUNT_RATE,COUNT_MAX,TIMEVALUES
      DATA GVAL/6.6704E-8/
      DATA TWPI/6.2831853071795864769D0/
      DATA RAD/57.295779513082320876798D0/
      DATA IN1,IN2,IN3,IN4,IN5,IN6,IN7/1,2,3,4,5,6,7/
      DATA NOUT1,NOUT2/8,9/
      DATA KEYBAD/-1/
      DATA KEYGOOD/0/
  100 FORMAT (A36)
  201 FORMAT (5F16.13)
  101 FORMAT (I2)
  103 FORMAT (1H1)
  104 FORMAT (1X,'PROGRAM PGG',60X,'DATE=',I2,'/',I2,'/',I4,2X,'TIME=',
     $I2,':',I2,':',I2,'.'I2)
  106 FORMAT (10I5)
  107 FORMAT (A80)
  123 FORMAT (6D20.12)
  124 FORMAT (1X,'Second order coefficient out of bounds,KERR=',I3)
  125 FORMAT (1X,'Reached end of file on unit IN3')
  126 FORMAT (1X,'Read error,unit IN3')
  127 FORMAT (4D20.12)
  205 FORMAT (1X,'Program running time=',F14.4,2X,'seconds')
C************************************************************************
C
      OPEN (UNIT=  10,   FILE='PGG.ILS',  STATUS='OLD')
      READ (10, 100)     (FL1(J),J=1,9)
      OPEN (UNIT=IN1,   FILE=FL1(1),  STATUS='OLD')
      WRITE (IN1, 101) KEYBAD
      REWIND IN1
      OPEN (UNIT=IN2,   FILE=FL1(2),  STATUS='OLD')
      OPEN (UNIT=IN3,   FILE=FL1(3),  STATUS='OLD')
      OPEN (UNIT=IN4,   FILE=FL1(4),  STATUS='OLD')
      OPEN (UNIT=IN5,   FILE=FL1(5),  STATUS='OLD')
      OPEN (UNIT=IN6,   FILE=FL1(6),  STATUS='OLD')
      OPEN (UNIT=IN7,   FILE=FL1(7),  STATUS='OLD')
      OPEN (UNIT=NOUT1, FILE=FL1(8),  STATUS='REPLACE')
      OPEN (UNIT=NOUT2, FILE=FL1(9),  STATUS='REPLACE')
C************************************************************************
      CALL SYSTEM_CLOCK(CLOCK1)
      CALL DATE_AND_TIME(DATE,TIME,ZONE,TIMEVALUES)
      IYR=TIMEVALUES(1)
      IMON=TIMEVALUES(2)
      IDAY=TIMEVALUES(3)
      IHR=TIMEVALUES(5)
      IMIN=TIMEVALUES(6)
      ISEC=TIMEVALUES(7)
      WRITE (NOUT1,103)
      WRITE (NOUT1,104) IMON,IDAY,IYR,IHR,IMIN,ISEC,I100TH
      LABEL=  ' ***PGB'
      NU=IN2
      CALL GTLBL(LABEL, LBLERR)
      CALL DUMMY(10)
      CALL DREAD (ECC, 'F10.8')   !Current orbital eccentricity
      CALL DUMMY (1)
      CALL DREAD (OMD, 'F10.8')   !Current longitude of node
      OMDR=OMD/RAD
      READ (IN5,106) KCTRL,NPSI   !NPSI
      READ (IN5,201) (PHSIV(K),K=1,NPSI)
      READ (IN5,201) VJ
      IF (NPSI.EQ.0) CALL PMDSTOP
C     Read values of current parameters
      CALL RDWT1(FL,HFER,I,KC,KL,NT,NTH,MN,QS,QN,RI,VMI,VVI,VVJ,IN7)
      CALL RDWT3(I,NT,NWL,WL,AX,BX,CX,DX,EX,FX,GX,
     $QXV,ZZ,HX,BA,BB,UAZ,UBZ,IN6)
      UC(I)=AX
      UC(3-I)=BX
      C1(I)=CX
      C2(I)=DX
      C1(3-I)=EX
      C2(3-I)=FX
      T0(I)=GX
      T0(3-I)=QXV
      A(I)=ZZ
      A(3-I)=HX
      BCF(I)=BA
      BCF(3-I)=BB
      UA(I)=UAZ
      UA(3-I)=UBZ
      TE(I)=T0(I)
      TE(3-I)=T0(3-I)
      KERR=0
      DO 20 IWL=1,NWL
C     Read data from PGH5
      DO 10 K=1,NPSI
      READ (IN3,123,END=90,ERR=91) PHS(K),VI,DI,SMVI(K),DMVI(K),
     $ECCR,DECC,SMECC(K),DMECC(K),
     $OMRADR,DOMRAD,SMOM(K),DMOM(K),
     $POT1,DVPOT1,SMPT1(K),DMPT1(K),
     $POT2,DVPOT2,SMPT2(K),
     $DMPT2(K),QR,DQ,SMQ(K),DMQ(K)
   10 CONTINUE 
C     Read data from PGH14
      DO 11 K=1,NPSI
      READ (IN4,123,END=90,ERR=91) PHSV,TE1,DVTE1,SMTE1(K),DMTE1(K),
     $TE2,DVTE2,SMTE2(K),DMTE2(K),
     $A1,DVA1,SMA1(K),DMA1(K),
     $A2,DVA2,SMA2(K),DMA2(K),
     $BCF1,DVBCF1,SMBCF1(K),DMB1(K),
     $BCF2,DVBCF2,SMBCF2(K),DMB2(K)
      IF (PHSV.NE.PHS(K)) CALL PMDSTOP
   11 CONTINUE      
      HI=1.0
      IF (DI.EQ.0.D0) GO TO 21
      DIV=VJ-VI
      HI=DIV/DI
      IF ((HI.GT.1.D0).OR.(HI.LT.-1.D0)) KERR=1
      IF (HI.GT.1.D0) HI=1.D0
      IF (HI.LT.-1.D0) HI=-1.D0
   21 IF (DECC.EQ.0.D0) GO TO 22
      DLECC=(ECC-ECCR)/DECC
      IF ((ECC.GE.1.D0).OR.(ECC.LT.0.D0)) KERR=2
      IF ((ECCR.GE.1.D0).OR.(ECCR.LT.0.D0)) KERR=2
   22 IF (DOMRAD.EQ.0.D0)GO TO 41
      DLOM=(OMDR-OMRADR)/DOMRAD
      IF (OMD.GT.360.D0) KERR=3
      IF (OMRADR.GT.TWPI) KERR=3
   41 IF (DVPOT1.EQ.0.0) GO TO 42
      B=QS*QS/(1.D0+QS)/2.D0
      RPOT=VVI*RI/GVAL/VMI-B
      CPOT1=POT1*RI/GVAL/VMI-B
      DPOT1=RPOT-CPOT1
      HPOT1=DPOT1/DVPOT1
      IF ((HPOT1.GT.1.D0).OR.(HPOT1.LT.-1.D0)) KERR=2
      IF (HPOT1.GT.1.D0) HPOT1=1.D0
      IF (HPOT1.LT.-1.D0) HPOT1=-1.D0
   42 IF (DVPOT2.EQ.0.D0) GO TO 43
      B=QN*QN/(1.0+QN)/2.D0
      RPOT=VVJ*RI/GVAL/VMI-B
      CPOT2=POT2*RI/GVAL/VMI-B
      DPOT2=RPOT-CPOT2
      HPOT2=DPOT2/DVPOT2
      IF ((HPOT2.GT.1.D0).OR.(HPOT2.LT.-1.D0)) KERR=3
      IF (HPOT2.GT.1.D0) HPOT2=1.D0
      IF (HPOT2.LT.-1.D0) HPOT2=-1.D0
   43 IF (DQ.EQ.0.D0) GO TO 44
      DQV=QS-QR
      HQ=DQV/DQ
      IF ((HQ.GT.1.D0).OR.(HQ.LT.-1.D0)) KERR=4
      IF (HQ.GT.1.D0) HQ=1.D0
      IF (HQ.LT.-1.D0) HQ=-1.D0
   44 DIV=TE(I)-TE1
      HTE1=0.D0
      IF (DVTE1.NE.0.D0) HTE1=DIV/DVTE1
      DIV=TE(3-I)-TE2
      HTE2=0.D0
      IF (DVTE2.NE.0.D0) HTE2=DIV/DVTE2
      DIV=A(I)-A1
      HA1=0.D0
      IF (DVA1.NE.0.D0) HA1=DIV/DVA1
      DIV=A(3-I)-A2
      HA2=0.D0
      IF (DVA2.NE.0.D0) HA2=DIV/DVA2
      DIV=BCF(I)-BCF1
      HB1=0.D0
      IF (DVBCF1.NE.0.D0) HB1=DIV/DVBCF1
      DIV=BCF(3-I)-BCF2
      HB2=0.D0
      IF (DVBCF2.NE.0.D0) HB2=DIV/DVBCF2   
      DO 39 K=1,NPSI
      IF (DI.EQ.0.D0) GO TO 25
      DVI=(SMVI(K)+HI*DMVI(K))/DI
   25 IF (DECC.EQ.0.D0) GO TO 45
      DVECC=(SMECC(K)+DLECC*DMECC(K))/DECC
   45 IF (DLOM.EQ.0.D0) GO TO 55
      DVOM=(SMOM(K)+DLOM*DMOM(K))/DOMRAD
   55 IF (DVPOT1.EQ.0.D0) GO TO 26
      DVPT1=(SMPT1(K)+HPOT1*DMPT1(K))/DVPOT1
   26 IF (DVPOT2.EQ.0.D0) GO TO 27
      DVPT2=(SMPT2(K)+HPOT2*DMPT2(K))/DVPOT2
   27 IF (DQ.EQ.0.D0) GO TO 28
      DVQ=  (SMQ(K)  +HQ   *DMQ(K))  /DQ 
   28 IF (DVTE1.EQ.0.D0) GO TO 29
      DTE1=(SMTE1(K)+HTE1*DMTE1(K))/DVTE1
   29 IF (DVTE2.EQ.0.D0) GO TO 30
      DTE2=(SMTE2(K)+HTE2*DMTE2(K))/DVTE2
   30 IF (DVA1.EQ.0.D0) GO TO 31
      DA1=(SMA1(K)+HA1*DMA1(K))/DVA1
   31 IF (DVA2.EQ.0.D0) GO TO 32
      DA2=(SMA2(K)+HA2*DMA2(K))/DVA2
   32 IF (DVBCF1.EQ.0.D0) GO TO 33
      DBCF1=(SMBCF1(K)+HB1*DMB1(K))/DVBCF1
   33 IF (DVBCF2.EQ.0.D0) GO TO 34
      DBCF2=(SMBCF2(K)+HB2*DMB2(K))/DVBCF2                  
   34 WRITE (NOUT2,123) PHS(K),DVI,DVECC,DVOM,DVPT1,DVPT2,DVQ,DTE1,
     $DTE2,DA1,DA2,DBCF1,DBCF2
   39 CONTINUE
      IF (KERR.EQ.0) GO TO 20
      WRITE (NOUT1,124) KERR
   20 CONTINUE
  199 CONTINUE
      CALL SYSTEM_CLOCK(CLOCK2,COUNT_RATE,COUNT_MAX)
      AAA=CLOCK1
      B=CLOCK2
      C=COUNT_RATE
      TM=(B-AAA)/C
      WRITE (NOUT1, 205) TM
      CLOSE (UNIT=IN2,   STATUS='KEEP')
      CLOSE (UNIT=IN3,   STATUS='KEEP')
      CLOSE (UNIT=IN4,   STATUS='KEEP')
      CLOSE (UNIT=IN5,   STATUS='KEEP')
      CLOSE (UNIT=IN6,   STATUS='KEEP')
      CLOSE (UNIT=IN7,   STATUS='KEEP')
      CLOSE (UNIT=NOUT1, STATUS='KEEP')
      CLOSE (UNIT=NOUT2, STATUS='KEEP')
      WRITE (IN1, 101)   KEYGOOD
      CLOSE (UNIT=IN1,   STATUS='KEEP')
      STOP
   90 WRITE (NOUT1,125)
      CALL PMDSTOP
   91 WRITE (NOUT1,126)
      CALL PMDSTOP
      END PROGRAM PGG
