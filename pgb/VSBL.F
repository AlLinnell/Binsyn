
      SUBROUTINE VSBL(I,NTH,NOUT7) 
C     SRT TO SET VISIBILITY LIMITS IN ARRAYS VST AND VND   
C     NOTE THAT A GIVEN THETA CIRCLE,ON COMPONENT I,MAY HAVE TWO  
C     OR POSSIBLY THREE INDEPENDENT REGIONS OF VISIBILITY      
C     GMNA=ARRAY OF MINIMUM VALUES OF COSINE GAMMA ON THETA CIRCLES
C     GMXA=ARRAY OF MAXIMUM COSINE GAMMA VALUES ON THETA CIRCLES   
C     PHMNA=ARRAY OF VALUES OF LONGITUDE CORRESPONDING TO GMNA VALUES      
C     PHMXA=ARRAY OF VALUES OF LONGITUDE CORRESPONDING TO GMXA VALUES      
C     THP=THETA VALUE FROM WHICH INTEGRATION SHOULD BEGIN  
C     THM=THETA VALUE TO WHICH INTEGRATION SHOULD EXTEND   
C     PHP=LONGITUDE FOR WHICH THP IS ON THE HORIZON 
C     PHM=LONGITUDE FOR WHICH THM IS ON THE HORIZON 
C     THP SPECIFIES THE REGION AROUND THE UPPER POLE WHICH IS ENTIRELY   
C     BELOW THE HORIZON 
C     THM SEPECIFIES THE REGION AROUND THE LOWER POLE WHICH IS ENTIRELY  
C     BELOW THE HORIZON 
C     TFP SPECIFIES THE REGION AROUND THE UPPER POLE WHICH IS ENTIRELY   
C     ABOVE THE HORIZON,EITHER BECAUSE OF ORBITAL INCLINATION OR  
C     TIDAL DISTORTION  
C     TFM SPECIFIES THE REGION AROUND THE LOWER POLE WHICH IS ENTIRELY   
C     ABOVE THE HORIZON,EITHER BECAUSE OF ORBITAL INCLINATION OR
C     TIDAL DISTORTION 
C     PFP AND PFM ARE CORRESPONDING VALUES OF LONGITUDE ON THE STELLAR
C     COMPONENT
	INCLUDE 'COMA.FOR'
	INCLUDE 'COMM.FOR'
      DIMENSION AR1(MTN),AR2(MTN),AR3(MPHM),AR4(MPHM)
      DIMENSION DF1(MFR),DF2(MFR)
      DATA PI/3.1415926535898D0/ 
      DATA PIO2/1.5707963267949D0/      
      DATA TPIO2/4.7123889803847D0/     
      DATA TWPI/6.2831853071796D0/      
      DATA ANG/6.29D0/
	DATA ER/1.D-10/
	DATA ERLT/1.D-13/
 1005 FORMAT (1X,'VSBL')
      IST=1      
      IND=1 
	NVL=NTH     
      IF (NTH.LT.3) CALL PMDSTOP 
C  
C     PRINCIPAL LOOP    
C
      DO 50 ITH=1,NTH
	VTH=TH(I,ITH)   
      N=NPH(I,ITH)      
C     ASSUME CIRCLE IS FULLY VISIBLE
      VST(I,ITH,1)=PH(I,ITH,1)
	VND(I,ITH,1)=PH(I,ITH,N)
	IF (ITH.EQ.NTH) VND(I,ITH,1)=TWPI  
      VST(I,ITH,2)=ANG  
      VND(I,ITH,2)=ANG  
      VST(I,ITH,3)=ANG  
      VND(I,ITH,3)=ANG
C	GO TO 50
C     FILL AR3 WITH PHI VALUES FOR THAT THETA PROFILE      
C     FILL AR4 WITH CORRESPONDING COS(GAMMA) VALUES 
      IF (N.GT.1) THEN
	DO 1 K=1,N
		AR3(K)=PH(I,ITH,K)
		AR4(K)=CSG(I,ITH,K)
		CALL SGLTP(TH(I,ITH),PH(I,ITH,K),ER,RV,GV,VLV,VMV,VNV,
     $		VCSB,VCSG,I,NTH)
		ERRV=VCSG-AR4(K)
C	IF ((ITH.EQ.4).AND.(I.EQ.1)) THEN
C	WRITE (NOUT7,1000) I,ITH,K,TH(I,ITH),PH(I,ITH,K),AR4(K),VCSG,ERRV
C	END IF
 1000 FORMAT (3I5,5F12.8)
 1001 FORMAT (' ')
    1	CONTINUE
c      WRITE (NOUT7,1001)
      END IF
C	IF ((ITH.GT.4).AND.(I.EQ.1)) STOP
C	IF ((ITH.GT.1).AND.(I.EQ.1)) STOP
C      IF ((I.EQ.1).AND.(N.GT.1)) STOP
C     SET LAST POINT SO THAT TWO POINTS IN SUCCESSION MAY BE TESTED      
      KF=N-1
	IF (N.EQ.1) GO TO 30
      GO TO 13
C  
C     LOOP FOR LOCATING HORIZON POINTS ON A GIVEN THETA CIRCLE    
C     HORIZON DEFINED BY ROOT OF COS(GAMMA),SO FIND ROOT IN AR4   
C
C     Arrive here if single point on that theta profile
   30 IF (CSG(I,ITH,1).LT.0.D0) VST(I,ITH,1)=ANG
      IF (DABS(CSG(I,ITH,1)).LE.ERLT) VST(I,ITH,1)=0.D0
      IF (CSG(I,ITH,N).LT.0.D0) VND(I,ITH,1)=ANG
	IF (DABS(CSG(I,ITH,N)).LE.ERLT) VND(I,ITH,1)=0.D0
      GO TO 50
   13 DO 40 K=1,KF
      IF (K.GT.1) GO TO 49
C     Arrive here if this is the first point of many on that ITH profile
C     If the first point is visible, it starts the visibility section
      IF (AR4(K).GT.0.D0) THEN
		AA=AR3(K)
		GO TO 80
	END IF
C     Past the first point, make further tests		     
	IF ((AR4(K).LT.0.D0).AND.(AR4(K+1).LT.0.D0))GO TO 40
	IF ((AR4(K).GT.0.D0).AND.(AR4(K+1).GT.0.D0))GO TO 40
	IF ((AR4(K).LT.0.D0).AND.(AR4(K+1).GT.0.D0)) GO TO 41
	IF (DABS(AR4(K)).LT.1.0D-16) THEN     
		VST(I,ITH,IST)=AR3(K)    
		IST=IST+1  
		GO TO 40
	END IF
	IF ((AR4(K).GT.0.D0).AND.(AR4(K+1).LT.0.D0)) GO TO 45
	CALL PMDSTOP
C     Arrive here if we are past the first point on that ITH profile
   49 IF ((AR4(K).LT.0.D0).AND.(AR4(K+1).GE.0.D0)) GO TO 41
      IF ((DABS(AR4(K)).LT.1.0D-16).AND.(AR4(K+1).GT.0.D0)) GO TO 41  
      IF ((AR4(K).LT.0.D0).AND.(DABS(AR4(K+1)).LT.1.0D-16)) GO TO 41  
   48 IF ((AR4(K).GT.0.D0).AND.(AR4(K+1).LT.0.D0)) GO TO 45
      IF ((DABS(AR4(K)).LT.1.0D-16).AND.(AR4(K+1).LT.0.D0)) GO TO 45  
      IF ((AR4(K).GT.0.D0).AND.(DABS(AR4(K+1)).LT.1.0D-16)) GO TO 45  
      GO TO 40
C  
C     IF ARRIVE HERE,POINTS K AND K+1 BRACKET ROOT AND START VISIBLE     
C     STRIP      
C 
   41 IF (DABS(AR4(K)).LT.1.0D-16) THEN
      AA=AR3(K)
	IF (DABS(VST(I,ITH,IST)-AA).LT.ERLT) GO TO 40
	IF (DABS(VST(I,ITH,IST-1)-AA).LT.ERLT) GO TO 40
	GO TO 80
	END IF
	IF (DABS(AR4(K+1)).LT.1.0D-16) THEN
	AA=AR3(K+1)
	IF (DABS(VST(I,ITH,IST)-AA).LT.ERLT) GO TO 40
	IF (DABS(VST(I,ITH,IST-1)-AA).LT.ERLT) GO TO 40
	GO TO 80
	END IF
      AR1(1)=AR3(K)     
      AR1(3)=AR3(K+1)   
      AR2(1)=AR4(K)     
      AR2(3)=AR4(K+1)   
      DO 79 KLP=1,16    
      AR1(2)=(AR1(1)+AR1(3))/2.0D0      
      AA=AR1(2)  
      CALL SGLTR(I,ITH,AR1(2),ER,RV,GV,VLV,VMV,VNV,VCSB,WCSG)
C     If following test is true, we have found the root.	      
      IF (DABS(WCSG).LT.ER) GO TO 80
C     If we arrive here, use calculated WCSG to produce next iteration.
      IF ((WCSG.GT.AR2(1)).AND.(WCSG.LT.AR2(3))) THEN
		AR2(2)=WCSG
	ELSE
		IF (DABS(AR2(1)).LT.AR2(3)) AA=AR1(1)
		IF (DABS(AR2(3)).LT.AR2(1)) AA=AR1(3)
		GO TO 80
	END IF
C     Calculate approximation to root.
      CALL LAGIN(0.D0,AA,AR2,AR1,2,3,M(1),0.D0)
      IF (M(1).LT.3) CALL PMDSTOP     
      IF ((AA.GE.AR1(1)).AND.(AA.LE.AR1(3))) GO TO 77
      DO 70 J=1,2
      IF ((AR2(J).LT.0.D0).AND.(AR2(J+1).GT.0.D0)) GO TO 71  
      IF ((AR2(J).GT.0.D0).AND.(AR2(J+1).LT.0.D0)) GO TO 71  
   70 CONTINUE   
      CALL PMDSTOP
C     If AA is inaccurate, use midpoint as approximation.	      
   71 AA=(AR1(J)+AR1(J+1))/2.D0   
   77 CALL SGLTR(I,ITH,AA,ER,RV,GV,VLV,VMV,VNV,VCSB,WCSG)
C     If this approximation is within limit, use it as final value.         
      IF (DABS(WCSG).LT.ER) GO TO 80
	IF (DABS(AA-AR1(1)).LE.ERLT) GO TO 33
	IF (DABS(AA-AR1(3)).LE.ERLT) GO TO 42
	GO TO 43
   33 VST(I,ITH,IST)=AR1(1)
      GO TO 51
   42 VST(I,ITH,IST)=AR1(3)
      GO TO 51
C     Sort the next approximation into array AR2.
   43 AR1(4)=AR1(3)+100.D0
      CALL SRTA(AA,WCSG,AR1,AR2,0,4)
C     Locate the index immediately preceeding the root.	  
      DO 81 K1=1,4      
      IF ((AR2(K1).LT.0.D0).AND.(AR2(K1+1).GT.0.D0)) GO TO 85
   81 CONTINUE   
      CALL PMDSTOP
C     Make room in AR1 and AR2 for next approximation.	     
   85 AR1(1)=AR1(K1)    
      AR1(3)=AR1(K1+1)  
      AR2(1)=AR2(K1)    
      AR2(3)=AR2(K1+1)
   79 CONTINUE
      IF (DABS(AR1(1)-AR1(3))-1.D-7.GT.0.D0) CALL PMDSTOP      
   80 VST(I,ITH,IST)=AA 
   51 IST=IST+1
C     Test for end point within same interval     
      IF ((AR4(K).GT.0.D0).AND.(AR4(K+1).LT.0.D0)) GO TO 45
      IF ((DABS(AR4(K)).LT.1.0D-16).AND.(AR4(K+1).LT.0.D0)) GO TO 45  
      IF ((AR4(K).GT.0.D0).AND.(DABS(AR4(K+1)).LT.1.0D-16)) GO TO 45  
      GO TO 40   
C  
C     IF ARRIVE HERE,POINTS K AND K+1 BRACKET ROOT AND END VISIBLE
C     STRIP
C  
   45 IF (DABS(AR4(K)).LT.1.0D-16) THEN
      AA=AR3(K)
	IF (DABS(VND(I,ITH,IST)-AA).LT.ERLT) GO TO 40
	IF (DABS(VND(I,ITH,IST-1)-AA).LT.ERLT) GO TO 40
	GO TO 76
	END IF
	IF (DABS(AR4(K+1)).LT.1.0D-16) THEN
	AA=AR3(K+1)
	IF (DABS(VND(I,ITH,IST)-AA).LT.ERLT) GO TO 40
	IF (DABS(VND(I,ITH,IST-1)-AA).LT.ERLT) GO TO 40
	GO TO 76
	END IF
      IF (N.LT.9) CALL PMDSTOP 
   46 AR1(1)=AR3(K)     
      AR1(3)=AR3(K+1)   
      AR2(1)=AR4(K)     
      AR2(3)=AR4(K+1)   
      DO 96 KLP=1,16    
      AR1(2)=(AR1(1)+AR1(3))/2.D0
      AA=AR1(2)  
      CALL SGLTR(I,ITH,AR1(2),ER,RV,GV,VLV,VMV,VNV,VCSB,WCSG)      
      IF (DABS(WCSG).LT.ER) GO TO 76
	IF ((WCSG.LT.AR2(1)).AND.(WCSG.GT.AR2(3))) THEN
		AR2(2)=WCSG
	ELSE
		IF (DABS(AR2(1)).LT.AR2(3)) AA=AR1(1)
		IF (DABS(AR2(3)).LT.AR2(1)) AA=AR1(3)
		GO TO 76
	END IF
	CALL LAGIN(0.D0,AA,AR2,AR1,2,3,M(1),0.D0)
	IF (M(1).LT.3) CALL PMDSTOP
      IF ((AA.GE.AR1(1)).AND.(AA.LE.AR1(3)))GO TO 93
      DO 86 J=1,2
      IF ((AR2(J).LT.0.D0).AND.(AR2(J+1).GT.0.D0)) GO TO 87  
      IF ((AR2(J).GT.0.D0).AND.(AR2(J+1).LT.0.D0)) GO TO 87  
   86 CONTINUE   
      CALL PMDSTOP      
   87 AA=(AR1(J)+AR1(J+1))/2.D0   
   93 CALL SGLTR(I,ITH,AA,ER,RV,GV,VLV,VMV,VNV,VCSB,WCSG)      
      IF (DABS(WCSG).LT.ER) GO TO 76
	IF (DABS(AA-AR1(1)).LE.ERLT) GO TO 60
	IF (DABS(AA-AR1(3)).LE.ERLT) GO TO 62
	GO TO 63
   60 VND(I,ITH,IND)=AR1(1)
      GO TO 53
   62 VND(I,ITH,IND)=AR1(3)
      GO TO 53
   63 AR1(4)=AR1(3)+100.D0
      CALL SRTA(AA,WCSG,AR1,AR2,0,4)  
      DO 91 K1=1,4      
      IF ((AR2(K1).GT.0.D0).AND.(AR2(K1+1).LT.0.D0)) GO TO 92
   91 CONTINUE   
      CALL PMDSTOP      
   92 AR1(1)=AR1(K1)    
      AR1(3)=AR1(K1+1)  
      AR2(1)=AR2(K1)    
      AR2(3)=AR2(K1+1)  
   96 CONTINUE   
      IF (DABS(AR1(1)-AR1(3))-1.D-7.GT.0.D0) CALL PMDSTOP      
   76 VND(I,ITH,IND)=AA 
   53 IND=IND+1
C     Test for beginning section within same interval     
      IF ((AR4(K).LT.0.D0).AND.(AR4(K+1).GE.0.D0)) GO TO 41
      IF ((DABS(AR4(K)).LT.1.0D-16).AND.(AR4(K+1).GT.0.D0)) GO TO 41  
      IF ((AR4(K).LT.0.D0).AND.(DABS(AR4(K+1)).LT.1.0D-16)) GO TO 41  
   40 CONTINUE   
C  
C     NOW TEST LAST POINT ON THAT THETA CIRCLE      
      IF (CSG(I,ITH,N).NE.0.D0) GO TO 54 
      IF (CSG(I,ITH,N-1).LT.0.D0) GO TO 55      
C     IF ARRIVE HERE,END VISIBILITY REGION   
      GO TO 56   
C     IF ARRIVE HERE,START VISIBILITY REGION
   55 VST(I,ITH,IST)=PH(I,ITH,N) 
      IST=IST+1  
      GO TO 44   
   54 IF (CSG(I,ITH,N).LT.0.D0) GO TO 44
   56 VND(I,ITH,IND)=PH(I,ITH,N) 
      IND=IND+1  
   44 IF (IST.GT.2) GO TO 20   
      VST(I,ITH,IST)=ANG
   20 IF (IND.GT.2) GO TO 21   
      VND(I,ITH,IND)=ANG
   21 IST=1      
      IND=1      
C
C     HAVE NOW LOCATED VST, VND VALUES ON THAT THETA PROFILE  
C  
C     FIND MAXIMA AND MINIMA OF COS(GAMMA) ON THAT THETA PROFILE  
C  
C  
C  
      KMX=0      
      KMN=0      
C     PHMXA ARE VALUES OF LONGITUDE FOR COS(GAMMA) MAXIMA
      PHMXA(I,ITH,1)=10.D0
      PHMXA(I,ITH,2)=20.D0
      PHMXA(I,ITH,3)=30.D0
      PHMXA(I,ITH,4)=40.D0
C     PHMNA ARE VALUES OF LONGITUDE FOR COS(GAMMA) MINIMA
      PHMNA(I,ITH,1)=11.D0
      PHMNA(I,ITH,2)=21.D0
      PHMNA(I,ITH,3)=31.D0
      PHMNA(I,ITH,4)=41.D0
C     GMXA ARE MAXIMUM VALUES OF COS(GAMMA) ON THAT THETA PROFILE
      GMXA(I,ITH,1)=10.D0
      GMXA(I,ITH,2)=10.D0
      GMXA(I,ITH,3)=10.D0
      GMXA(I,ITH,4)=10.D0
C     GMNA ARE MINIMUM VALUES OF COS(GAMMA) ON THAT THETA PROFILE
      GMNA(I,ITH,1)=10.D0
      GMNA(I,ITH,2)=10.D0
      GMNA(I,ITH,3)=10.D0
      GMNA(I,ITH,4)=10.D0
      IF (N.GT.1) GO TO 401    
      GMXA(I,ITH,1)=CSG(I,ITH,1)  
      GMNA(I,ITH,1)=CSG(I,ITH,1)  
      PHMXA(I,ITH,1)=CM  
      PHMNA(I,ITH,1)=CM+PI      
      IF (PHMNA(I,ITH,1).GE.TWPI) PHMNA(I,ITH,1)=PHMNA(I,ITH,1)-TWPI 
      GO TO 50   
  401 DO 400 K=1,KF     
C     RANGE OF DO LOOP PROTECTS US FROM FINAL POINT 
      IF (K.GT.1) GO TO 37     
C     TEST THE FIRST POINT     
      IF (AR4(K+1).GT.AR4(K)) GO TO 34
   61 KMX=KMX+1  
      PHMXA(I,ITH,KMX)=AR3(K)   
      GMXA(I,ITH,KMX)=AR4(K)    
      GO TO 400  
   34 KMN=KMN+1  
      PHMNA(I,ITH,KMN)=AR3(1)   
      GMNA(I,ITH,KMN)=AR4(1)    
      GO TO 400  
C     IF WE ARRIVE HERE,WE ARE PAST THE FIRST POINT 
   37 IF ((AR4(K).GT.AR4(K+1)).AND.(AR4(K).GT.AR4(K-1))) GO TO 38 
      IF ((AR4(K).LT.AR4(K+1)).AND.(AR4(K).LT.AR4(K-1))) GO TO 39 
      GO TO 400  
C     LOCAL MAXIMUM BETWEEN AR3(K-1) AND AR3(K+1)   
   38 KMX=KMX+1  
      KY=0
      CALL THRT(I,AR3(K-1),AR3(K+1),AR3(1),AR3(N),VTH,PHMXA(I,ITH,KMX),   
     $GMXA(I,ITH,KMX),NVL,KY)   
      IF (GMXA(I,ITH,KMX).GT.AR4(K)) GO TO 400
      PHMXA(I,ITH,KMX)=AR3(K)   
      GMXA(I,ITH,KMX)=AR4(K)    
      GO TO 400  
C     LOCAL MINIMUM BETWEEN AR3(K-1) AND AR3(K+1)   
   39 KMN=KMN+1  
      KY=1
      CALL THRT(I,AR3(K-1),AR3(K+1),AR3(1),AR3(N),VTH,PHMNA(I,ITH,KMN),   
     $GMNA(I,ITH,KMN),NVL,KY)   
  403 IF (GMNA(I,ITH,KMN).LT.AR4(K)) GO TO 400
      PHMNA(I,ITH,KMN)=AR3(K)   
      GMNA(I,ITH,KMN)=AR4(K)    
  400 CONTINUE   
      IF (AR4(N-1).GT.AR4(N)) GO TO 402      
      KMX=KMX+1  
      PHMXA(I,ITH,KMX)=AR3(N)   
      GMXA(I,ITH,KMX)=AR4(N)    
      GO TO 405  
  402 KMN=KMN+1  
      PHMNA(I,ITH,KMN)=AR3(N)   
      GMNA(I,ITH,KMN)=AR4(N)    
C     SORT MAXIMA AND MINIMA INTO ARRAYS AR3 AND AR4
  405 AR3(N+1)=AR3(N)   
      AR3(N+2)=AR3(N)   
      AR3(N+3)=AR3(N)   
      AR3(N+4)=AR3(N)   
      AR4(N+1)=AR4(N)   
      AR4(N+2)=AR4(N)   
      AR4(N+3)=AR4(N)   
      AR4(N+4)=AR4(N)   
      N=N+4      
      DO 6 J=1,3 
      DO 2 K=1,N 
      IF (DABS(PHMXA(I,ITH,J)-AR3(K)).LT.0.000001D0) GO TO 3   
    2 CONTINUE   
      CALL SRTA(PHMXA(I,ITH,J),GMXA(I,ITH,J),AR3,AR4,1,N)    
    3 DO 4 K=1,N 
      IF (DABS(PHMNA(I,ITH,J)-AR3(K)).LT.0.000001D0) GO TO 6   
    4 CONTINUE   
      CALL SRTA(PHMNA(I,ITH,J),GMNA(I,ITH,J),AR3,AR4,1,N)    
    6 CONTINUE   
   50 CONTINUE
C     NOW HAVE LOCATED ROOTS OF COS(GAMMA) ON THAT THETA PROFILE  
C     STARTING AND ENDING VALUES OF VISIBLE REGIONS ARE STORED IN 
C     VST(I,ITH,1),VND(I,ITH,1),VST(I,ITH,2),VND(I,ITH,2),VST(I,ITH,3),  
C     AND VND(I,ITH,3)  
C  
C     HAVE NOW FILLED ARRAYS PHMNA,GMNA,PHMXA,GMXA 
C  
C     NOW SEEK BOUNDING THETA PROFILES FOR REGIONS ENTIRELY ABOVE
C     HORIZON
C     AND REGIONS ENTIRELY BELOW HORIZON     
C     THP SPECIFIES REGION AROUND UPPER POLE WHICH IS ENTIRELY BELOW
C     HORIZON
C     THM SPECIFIES REGION AROUND LOWER POLE WHICH IS ENTIRELY BELOW
C     HORIZON
C     TFP SPECIFIES REGION AROUND UPPER POLE WHICH IS ENTIRELY ABOVE
C     HORIZON
C     TFM SPECIFIES REGION AROUND LOWER POLE WHICH IS ENTIRELY ABOVE
C     HORIZON
C  
C  
C     LOCATE ROOTS IN GMXA AND GMNA, FOR THETA BETWEEN 0.0 AND PIO2,
C     IF ANY EXIST
C  
C  
C     LOCATE THP AND PHP,AND TFP AND PFP     
C  
C  
C     A ROOT FOR SMALL THETA DETERMINES A NON-ZERO THP OR TFP
C     A ROOT FOR THETA NEAR PI DETERMINES THM OR TFM
C     INITIALIZE THP AND TFP TO VISIBILITY CONDITIONS      
      THP(I)=0.D0
      PHP(I)=CM+PI      
      TFP(I)=0.D0
      PFP(I)=CM      
      IF (PHP(I).GE.TWPI) PHP(I)=PHP(I)-TWPI 
C     INITIALIZE THM AND TFM   
      THM(I)=0.D0
      PHM(I)=CM+PI      
      TFM(I)=PI  
      PFM(I)=CM  
      IF (PHM(I).GE.TWPI) PHM(I)=PHM(I)-TWPI 
C  
C  
C     FIND THP AND PHP,AND TFP AND PFP
C     If upper pole is visible, THP=0.0 and TFP must be found
C     If upper pole is below horizon, TFP=0.0 and THP must be found
C
C
      CALL SGLTR(I,1,PHP(I),ER,RV,GV,VLV,VMV,VNV,VCSB,WCSG)
      IF (WCSG.LE.0.D0) JCTR=1
      IF (WCSG.GT.0.D0) JCTR=2
C  
C     START AT UPPER POLE FOR THP AND TFP
      IF (DABS(PHMXA(I,1,1)-TWPI)-ERLT.LT.0.D0) PHMXA(I,1,1)=0.D0
      IF (DABS(PHMNA(I,1,1)-TWPI)-ERLT.LT.0.D0) PHMNA(I,1,1)=0.D0
      IF (JCTR.EQ.1) AS=PHMXA(I,1,1)    
      IF (JCTR.EQ.1) GS=GMXA(I,1,1)     
      IF (JCTR.EQ.2) AS=PHMNA(I,1,1)
      IF (JCTR.EQ.2) GS=GMNA(I,1,1)
      KS=1
      DO 10 ITH=2,NTH
      N=NPH(I,ITH)
	PHBG=PH(I,ITH,1)
	PHND=PH(I,ITH,N)      
      DO K=1,N
	AR3(K)=PH(I,ITH,K)
      CALL SYN(I,ITH,K,AR4(K))
      END DO
C     PHBG AND PHND ALLOW FOR NECK REGION
C     AA is predicted value of longitude
C     GA is predicted value of cos(gamma)
C     KA is predicted region index containing the extremum
      AA=AS      
      GA=GS      
      KA=KS      
C     THE VALUES OF PHMXA AND PHMNA HAVE BEEN INITIALIZED TO GREATER 
C     THAN TWPI      
      IF (ITH.EQ.1) GO TO 10   
C     THE SINGLE EXTREMUM WILL ALWAYS OCCUR FOR ITH=2
      IF (ITH.EQ.NTH) GO TO 530
      IF (ITH.GT.2) THEN 
		IF (VST(I,ITH-1,1).NE.ANG) GO TO 500
	END IF
      IF (AA.GT.0.D0) GO TO 16
      KK=1
      GO TO 14
   16 DO 18 K=1,N-1
      KK=K
      DFA=AR3(K+1)-AR3(K)
      DFB=AA-AR3(K)
      IF (DABS(DFB).LT.1.D-6) GO TO 14
      IF((DFB.GT.0.D0).AND.(DFA.LE.DFB)) GO TO 18
C      IF (DFB.LT.0.D0) CALL PMDSTOP
      DFC=AR3(K+1)-AA
      IF (DFB.LT.DFC) GO TO 14
      KK=K+1
      GO TO 14
   18 CONTINUE
      KK=N
      DFB=AA-AR3(K)
      IF (DABS(DFB).LT.3.D-6) GO TO 14
      CALL PMDSTOP
   14 KAS=KK
      IF (JCTR.EQ.1) PHMXA(I,ITH,1)=AR3(KAS)
      IF (JCTR.EQ.2) PHMNA(I,ITH,1)=AR3(KAS)
      IF (JCTR.EQ.1) GMXA(I,ITH,1)=AR4(KAS)
      IF (JCTR.EQ.2) GMNA(I,ITH,1)=AR4(KAS)
C     CHOOSE THE PHMXA OR PHMNA THAT MATCHES THE ONE FOR THE LAST ITH
  500 DO 520 K=1,4      
      IF (JCTR.EQ.1) DF1(K)=PHMXA(I,ITH,K)-AA  
      IF (JCTR.EQ.1) DF2(K)=DABS(PHMXA(I,ITH,K)-AA)-TWPI      
      IF (JCTR.EQ.2) DF1(K)=PHMNA(I,ITH,K)-AA
      IF (JCTR.EQ.2) DF2(K)=DABS(PHMNA(I,ITH,K)-AA)-TWPI
  520 CONTINUE
      DF1MN=DABS(DF1(1)) 
      KMN1=1     
      DO 522 K=2,4      
      IF (DABS(DF1(K)).GT.DF1MN) GO TO 522    
      DF1MN=DABS(DF1(K)) 
      KMN1=K     
  522 CONTINUE   
      DF2MN=DABS(DF2(1)) 
      KMN2=1     
      DO 523 K=2,4      
      IF (DABS(DF2(K)).GT.DF2MN) GO TO 523    
      DF2MN=DABS(DF2(K)) 
      KMN2=K     
  523 CONTINUE
C     Check that we are tracking the right extremum
      IF (JCTR.EQ.1) TS1=GMXA(I,ITH,KMN1)
      IF (JCTR.EQ.1) TS2=GMXA(I,ITH,KMN2)
      IF (JCTR.EQ.2) TS1=GMNA(I,ITH,KMN1)
      IF (JCTR.EQ.2) TS2=GMNA(I,ITH,KMN2)
      IF ((JCTR.EQ.1).AND.(TS1-TS2.GE.0.D0)) K=KMN1
      IF ((JCTR.EQ.1).AND.(TS2-TS1.GT.0.D0)) K=KMN2
      IF ((JCTR.EQ.2).AND.(TS1-TS2.LE.0.D0)) K=KMN1
      IF ((JCTR.EQ.2).AND.(TS2-TS1.LT.0.D0)) K=KMN2
C     WE HAVE LOCATED THE NEXT PHMXA OR PHMNA TO USE   
  521 IF (JCTR.EQ.1) AB=PHMXA(I,ITH,K)  
      IF (JCTR.EQ.1) GB=GMXA(I,ITH,K)   
      IF (JCTR.EQ.2) AB=PHMNA(I,ITH,K)
      IF (JCTR.EQ.2) GB=GMNA(I,ITH,K)
C     SAVE THE DATA FOR THE CURRENT ITH FOR COMPARISON WITH ITH+1 
      AS=AB      
      GS=GB      
      KS=K
C     IDENTIFY WHEN WE BRACKET A ROOT 
  531 IF((GA.LT.0.D0).AND.(GB.GT.0.D0)) GO TO 11      
      IF((GA.GT.0.D0).AND.(GB.LT.0.D0)) GO TO 11      
      IF (DABS(GA).LT.0.000000001D0) GO TO 35  
      IF (DABS(GB).LT.0.000000001D0) GO TO 36  
      GO TO 10
   35 RT=TH(I,ITH-1)	   
      IF (JCTR.EQ.1) RTA=PHMXA(I,ITH-1,K)      
      IF (JCTR.EQ.2) RTA=PHMNA(I,ITH-1,K)
      GO TO 233
   36 RT=TH(I,ITH)	  
      IF (JCTR.EQ.1) RTA=PHMXA(I,ITH,K) 
      IF (JCTR.EQ.2) RTA=PHMNA(I,ITH,K)
      GO TO 233  
C     SET THETA VALUE,CORRES.TO ITH,IN AR1(1)
   11 AR1(1)=TH(I,ITH-1)
      AR1(3)=TH(I,ITH)
      IF (JCTR.EQ.1) AR2(1)=GMXA(I,ITH-1,KA)   
      IF (JCTR.EQ.2) AR2(1)=GMNA(I,ITH-1,KA)
      RT=AR2(1)  
      IF (JCTR.EQ.1) RTA=PHMXA(I,ITH-1,KA)     
      IF (JCTR.EQ.2) RTA=PHMNA(I,ITH-1,KA)
      IF (DABS(RT).LT.0.000000001D0) GO TO 233  
      IF (JCTR.EQ.1) AR2(3)=GMXA(I,ITH,K)      
      IF (JCTR.EQ.2) AR2(3)=GMNA(I,ITH,K)
      RT=AR2(3)  
      IF (JCTR.EQ.1) RTA=PHMXA(I,ITH,K) 
      IF (JCTR.EQ.2) RTA=PHMNA(I,ITH,K)
      IF (DABS(RT).LT.0.000000001D0) GO TO 233  
      IF (KAS.GT.1) PH1=AR3(KAS-1)
      IF (KAS.EQ.1) PH1=AR3(1)
      PH2=AR3(KAS+1)
C     BE CAREFUL OF CASE WHERE THERE IS A MODULO TWPI PROBLEM     
      IF (DABS(PH2-PH1).LT.1.D0) GO TO 12      
      IF ((PH1.LE.PIO2).AND.(PH2.GE.TPIO2)) PH2=PH2-TWPI   
      IF ((PH1.GE.TPIO2).AND.(PH2.LE.PIO2)) PH1=PH1-TWPI
C     ITERATE UP TO 7 TIMES TO FIND ROOTS    
   12 DO 232 KCT=1,7    
   29 AR1(2)=(AR1(1)+AR1(3))/2.D0      
C     FIND PHI FOR EXTREMUM OF COS(GAMMA),BETWEEN PH1 AND PH2,AND STORE
C     IN PHEX
C     STORE THE VALUE OF COS(GAMMA) IN AR2(2)
      IF (ITH.LT.NTH) GO TO 32
      IF (JCTR.EQ.1) RT=GMXA(I,ITH,1)+PI
      IF (JCTR.EQ.2) RT=GMNA(I,ITH,1)+PI
      IF (RT.GT.PI) RT=PI
      IF (JCTR.EQ.1) RTA=PHMXA(I,ITH,1)
      IF (JCTR.EQ.2) RTA=PHMNA(I,ITH,1)
      GO TO 233
   32 IF (JCTR.EQ.1) KY=0
      IF (JCTR.EQ.2) KY=1
      CALL THRT(I,PH1,PH2,PHBG,PHND,AR1(2),PHEX,AR2(2),NVL,KY)
  404 CALL LAGIN(0.D0,RT,AR2,AR1,2,3,M(1),0.D0)
      IF (M(1).LT.3) CALL PMDSTOP     
      IF ((RT.GT.AR1(1)).AND.(RT.LT.AR1(3)))GO TO 27
      DO 28 KCTA=1,2    
      IF ((AR2(KCTA).GT.0.D0).AND.(AR2(KCTA+1).LT.0.D0)) GO TO 31   
      IF ((AR2(KCTA).LT.0.D0).AND.(AR2(KCTA+1).GT.0.D0)) GO TO 31   
   28 CONTINUE   
      CALL PMDSTOP      
   31 CALL LNTER(AR2(KCTA),AR1(KCTA),AR2(KCTA+1),AR1(KCTA+1),0.D0,
     $RT)     
   27 IF (JCTR.EQ.1) KY=0
      IF (JCTR.EQ.2) KY=1
      CALL THRT(I,PH1,PH2,PHBG,PHND,RT,RTA,VCSGA,NVL,KY)
  406 IF (DABS(VCSGA).LT.0.00000001D0) GO TO 233
      AR1(4)=1000.D0
      AR2(4)=1000.D0    
      CALL SRTA(RT,VCSGA,AR1,AR2,1,4)
C     FIND THE ARRAY ENTRIES THAT BRACKET THE ROOT  
      DO 230 K=1,3      
      IF ((AR2(K).LT.0.D0).AND.(AR2(K+1).GT.0.D0)) GO TO 231 
      IF ((AR2(K).GT.0.D0).AND.(AR2(K+1).LT.0.D0)) GO TO 231 
  230 CONTINUE   
      CALL PMDSTOP      
C     INITIALIZE ARRAYS FOR THE NEXT ITERATION      
  231 AR1(1)=AR1(K)     
      AR1(3)=AR1(K+1)   
      IF (DABS(AR1(3)-AR1(1)).LT.0.001D0) GO TO 233
      AR2(1)=AR2(K)     
      AR2(3)=AR2(K+1)   
  232 CONTINUE   
      CALL PMDSTOP      
  530 IF (JCTR.EQ.1) AB=PHMXA(I,ITH,1)  
      IF (JCTR.EQ.2) AB=PHMNA(I,ITH,1)
      IF (JCTR.EQ.1) GB=GMXA(I,ITH,1)   
      IF (JCTR.EQ.2) GB=GMNA(I,ITH,1)
      K=1 
      GO TO 531  
  233 IF (ITH.LE.NTH) GO TO 234
      CALL PMDSTOP
  234 IF ((THP(I).NE.0.D0).OR.(TFP(I).NE.0.D0)) GO TO 10
      IF (JCTR.EQ.1) THP(I)=RT  
      IF (JCTR.EQ.1) PHP(I)=RTA 
      IF (JCTR.EQ.2) TFP(I)=RT
      IF (JCTR.EQ.2) PFP(I)=RTA
      GO TO 235
   10 CONTINUE   
C  
C  
C  
C     NOW LOCATE THM AND PHM,AND TFM AND PFM 
C  
C  
  235 CALL SGLTR(I,NTH,PHM(I),ER,RV,GV,VLV,VMV,VNV,VCSB,WCSG)
      IF (WCSG.GT.0.D0) JCTR=1
      IF (WCSG.LE.0.D0) JCTR=2
C  
C     START AT LOWER POLE FOR THM AND TFM
      IF (JCTR.EQ.1) AS=PHMNA(I,NTH,1)  
      IF (JCTR.EQ.1) GS=GMNA(I,NTH,1)   
      IF (JCTR.EQ.2) AS=PHMXA(I,NTH,1)
      IF (JCTR.EQ.2) GS=GMXA(I,NTH,1)
      KS=1
      DO 210 ITJ=1,NTH
      AA=AS      
      GA=GS      
      KA=KS      
      ITH=NTH-ITJ+1     
      N=NPH(I,ITH)
	PHBG=PH(I,ITH,1)
	PHND=PH(I,ITH,N)      
      DO K=1,N
      CALL SYN(I,ITH,K,AR4(K))
      END DO
      IF (ITH.EQ.NTH) GO TO 540
      IF (ITJ.GT.2) GO TO 504
      IF (AA.GT.0.D0) GO TO 17
      KK=1
      GO TO 15
   17 DO 19 K=1,N-1
      KK=K
      DFA=AR3(K+1)-AR3(K)
      DFB=AA-AR3(K)
      DFC=AR3(K+1)-AA
      IF (DABS(DFB).LT.1.D-9) GO TO 15
      IF ((DFB.GT.0.D0).AND.(DFA.LE.DFB)) GO TO 19
      IF (DFB.LT.0.D0) CALL PMDSTOP
      IF (DFB.LT.DFC) GO TO 15
      KK=K+1
      GO TO 15
   19 CONTINUE
      IF (DABS(DFC).LE.ERLT) THEN
		KK=N
		GO TO 15
	END IF
      CALL PMDSTOP
   15 KAS=KK
      IF (JCTR.EQ.1) PHMNA(I,ITH,1)=AR3(KAS)
      IF (JCTR.EQ.2) PHMXA(I,ITH,1)=AR3(KAS)
      IF (JCTR.EQ.1) GMNA(I,ITH,1)=AR4(KAS)
      IF (JCTR.EQ.2) GMXA(I,ITH,1)=AR4(KAS)
C     BE SURE TO TRACK THE SAME MINIMUM      
  504 DO 505 K=1,4      
      IF (JCTR.EQ.1) DF1(K)=PHMNA(I,ITH,K)-AA  
      IF (JCTR.EQ.1) DF2(K)=DABS(PHMNA(I,ITH,K)-AA)-TWPI      
      IF (JCTR.EQ.2) DF1(K)=PHMXA(I,ITH,K)-AA
      IF (JCTR.EQ.2) DF2(K)=DABS(PHMXA(I,ITH,K)-AA)-TWPI
  505 CONTINUE
      DF1MN=DABS(DF1(1))
      KMN1=1
      DO 550 K=2,4      
      IF (DABS(DF1(K)).GT.DF1MN) GO TO 550    
      DF1MN=DF1(K)      
      KMN1=K     
  550 CONTINUE
      DF2MN=DABS(DF2(1))
      KMN2=1     
      DO 551 K=2,4      
      IF (DABS(DF2(K)).GT.DF2MN) GO TO 551    
      DF2MN=DF2(K)      
      KMN2=K     
  551 CONTINUE
      K=KMN1     
      IF (DABS(DF2MN).LT.DABS(DF1MN)) K=KMN2
C     WE HAVE LOCATED THE NEXT PHMNA TO USE   
  506 IF (JCTR.EQ.1) AB=PHMNA(I,ITH,K)  
      IF (JCTR.EQ.1) GB=GMNA(I,ITH,K)   
      IF (JCTR.EQ.2) AB=PHMXA(I,ITH,K)
      IF (JCTR.EQ.2) GB=GMXA(I,ITH,K)
      AS=AB      
      GS=GB      
      KS=K
  507 IF ((GA.LT.0.0D0).AND.(GB.GT.0.0D0)) GO TO 200    
      IF ((GA.GT.0.0D0).AND.(GB.LT.0.0D0)) GO TO 200    
      IF (DABS(GA).LT.0.0000000001D0) GO TO 209 
      IF (DABS(GB).LT.0.0000000001D0) GO TO 211 
      GO TO 210  
  209 RT=TH(I,ITH) 
      IF ((JCTR.EQ.1).AND.(ITH.LT.NTH)) RTA=PHMNA(I,ITH+1,K)      
      IF ((JCTR.EQ.1).AND.(ITH.EQ.NTH)) RTA=PHMNA(I,NTH,K)
      IF ((JCTR.EQ.2).AND.(ITH.LT.NTH)) RTA=PHMXA(I,ITH+1,K)
      IF ((JCTR.EQ.2).AND.(ITH.EQ.NTH)) RTA=PHMXA(I,NTH,K)
      GO TO 208  
  211 RT=TH(I,ITH)   
      IF (JCTR.EQ.1) RTA=PHMNA(I,ITH,K) 
      IF (JCTR.EQ.2) RTA=PHMXA(I,ITH,K)
      GO TO 208
  200 AR1(3)=TH(I,ITH+1)
      AR1(1)=TH(I,ITH)	  
      IF (JCTR.EQ.1) AR2(3)=GMNA(I,ITH+1,KA)   
      IF (JCTR.EQ.2) AR2(3)=GMXA(I,ITH+1,KA)
      ZR=AR2(3)
      RT=AR1(3)
      IF (JCTR.EQ.1) RTA=PHMNA(I,ITH+1,KA)     
      IF (JCTR.EQ.2) RTA=PHMXA(I,ITH+1,KA)
      IF (DABS(ZR).LT.0.000000001D0) GO TO 208
      IF (JCTR.EQ.1) AR2(1)=GMNA(I,ITH,K)      
      IF (JCTR.EQ.2) AR2(1)=GMXA(I,ITH,K)
      ZR=AR2(1)
      RT=AR1(1)
      IF (JCTR.EQ.1) RTA=PHMNA(I,ITH,K) 
      IF (JCTR.EQ.2) RTA=PHMXA(I,ITH,K)
      IF (DABS(ZR).LT.0.000000001D0) GO TO 208
      IF (KAS.GT.1) PH1=AR3(KAS-1)
      IF (KAS.EQ.1) PH1=AR3(1)
      PH2=AR3(KAS+1)
      IF (DABS(PH2-PH1).LT.1.D0) GO TO 241     
      IF ((PH1.GE.TPIO2).AND.(PH2.LE.PIO2)) PH1=PH1-TWPI   
      IF ((PH1.LE.PIO2).AND.(PH2.GE.TPIO2)) PH2=PH2-TWPI
  241 DO 242 KCT=1,7    
  243 AR1(2)=(AR1(1)+AR1(3))/2.D0      
      IF (ITJ.LT.NTH) GO TO 201
	RT=TH(I,NTH)
      IF (JCTR.EQ.1) ZR=GMNA(I,ITH,1)
      IF (JCTR.EQ.1) RTA=PHMNA(I,ITH,1)
      IF (JCTR.EQ.2) ZR=GMXA(I,ITH,1)
      IF (JCTR.EQ.2) RTA=PHMXA(I,ITH,1)
      GO TO 208
  201 IF (JCTR.EQ.1) KY=1
      IF (JCTR.EQ.2) KY=0
      IF (DABS(PH2-PH1).GT.0.0001D0) GO TO 202
      RT=0.5D0*(AR1(1)+AR1(3))
      RTA=0.5D0*(PH1+PH2)
      GO TO 208
  202 CALL THRT(I,PH1,PH2,PHBG,PHND,AR1(2),PHEX,AR2(2),NVL,KY)
  407 CALL LAGIN(0.D0,RT,AR2,AR1,2,3,M(1),0.D0)
      IF (M(1).EQ.0) GO TO 248 
      IF (M(1).NE.2) GO TO 247 
  248 PH1=PH1+PI 
      PH2=PH2+PI 
      CALL SGLTP(AR1(1),PH1,ER,RV,GV,VLV,VMV,VNV,VCSB,
     $AR2(1),I,NTH) 
      CALL SGLTP(AR1(3),PH2,ER,RV,GV,VLV,VMV,VNV,VCSB,
     $AR2(3),I,NTH)
      GO TO 242
  247 IF (M(1).LT.3) CALL PMDSTOP     
      IF ((RT.GT.AR1(1)).AND.(RT.LT.AR1(3)))GO TO 244      
      DO 249 KCTA=1,2   
      IF ((AR2(KCTA).GT.0.D0).AND.(AR2(KCTA+1).LT.0.D0)) GO TO 250  
      IF ((AR2(KCTA).LT.0.D0).AND.(AR2(KCTA+1).GT.0.D0)) GO TO 250  
  249 CONTINUE   
      CALL PMDSTOP      
  250 CALL LNTER(AR2(KCTA),AR1(KCTA),AR2(KCTA+1),AR1(KCTA+1),0.D0,
     $RT)
      IF (RT.LT.0.D0) GO TO 248 
  244 IF (JCTR.EQ.1) KY=1
      IF (JCTR.EQ.2) KY=0
      CALL THRT(I,PH1,PH2,PHBG,PHND,RT,RTA,VCSGA,NVL,KY)
  408 IF (DABS(VCSGA).LT.0.0000000001D0) GO TO 208
      AR1(4)=1000.D0
      AR2(4)=1000.D0    
      CALL SRTA(RT,VCSGA,AR1,AR2,1,4)
      DO 245 K=1,3      
      IF ((AR2(K).LT.0.D0).AND.(AR2(K+1).GT.0.D0)) GO TO 246 
      IF ((AR2(K).GT.0.D0).AND.(AR2(K+1).LT.0.D0)) GO TO 246 
  245 CONTINUE   
      CALL PMDSTOP      
  246 AR1(1)=AR1(K)     
      AR1(3)=AR1(K+1)   
      IF (DABS(AR1(3)-AR1(1)).LT.0.0001D0) GO TO 208
      AR2(1)=AR2(K)     
      AR2(3)=AR2(K+1)
  242 CONTINUE   
  540 IF (JCTR.EQ.1) AB=PHMNA(I,ITH,1)  
      IF (JCTR.EQ.1) GB=GMNA(I,ITH,1)   
      IF (JCTR.EQ.2) AB=PHMXA(I,ITH,1)
      IF (JCTR.EQ.2) GB=GMXA(I,ITH,1)
      K=1
      IF (KCT.LT.7) THEN
		GO TO 507
	ELSE
		GO TO 211
	END IF  
  208 IF (JCTR.EQ.2) GO TO 212
      TFM(I)=RT  
      PFM(I)=RTA
      GO TO 99   
  212 THM(I)=RT  
      PHM(I)=RTA
      GO TO 99
  210 CONTINUE
   99 CONTINUE
C     Test for special case of contact systems
      DO ITH=2,NTH
		IF ((VST(I,ITH,2).EQ.ANG).AND.(VST(I,ITH-1,2).NE.ANG)) THEN
C
			IF ((DABS(VST(I,ITH-1,2)-VST(I,ITH,1)).LT.
     $            (VST(I,ITH-1,2)/10D0)).AND.(DABS(VND(I,ITH-1,2)-
     $			VND(I,ITH,1)).LT.(VND(I,ITH-1,2)/10.D0))) THEN
					VST(I,ITH,2)=VST(I,ITH,1)
					VND(I,ITH,2)=VND(I,ITH,1)
					VST(I,ITH,1)=0.D0
					VND(I,ITH,1)=0.D0
			END IF
C
		END IF
	END DO
      RETURN     
      END 
