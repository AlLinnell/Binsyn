      SUBROUTINE SHDTS(VTH,VPHV,ALMV,AMUV,ANUV,I,TARY, 
     $IRC,IFC,NKP,XC,YC,VRHO,AGLD,ERVL,ISV,KCOR,IRD)
	INCLUDE 'COMA.FOR'
      DIMENSION TARY(MTR,MTR)
      DATA TWPI/6.2831853071795864769D0/
      CALL SGLTP(VTH,VPHV,0.000000001D0,RV,GV,VLV,VMV,VNV,VCSB,
     $VCSG,I,NTH)   
      X=RV*ALMV  
      Y=RV*AMUV  
      Z=RV*ANUV  
      CALL PROJ(TARY,X,Y,Z,XP,YP,ZP)  
      A=XP
      B=YP
      IF (KCOR.LT.0) GO TO 1
      A=XC+XP    
      B=YC+YP    
    1 IF (I.NE.ISV) GO TO 2
      A=XP-XC    
      B=YP-YC
    2 CONTINUE
      CALL RCTPOL(IRD,A,B,VRHOV1,AGLD1,1)
	CALL RCTPOL(IRD,A,B,VRHOV2,AGLD2,2)
	IF ((AGLD1.GE.ALP(1,1)).AND.(AGLD1.LE.ALP(IFC,1))) THEN
		AGLD=AGLD1
		VRHOV=VRHOV1
	END IF
	IF ((AGLD1.LE.ALP(1,1)).AND.(AGLD1.GE.ALP(IFC,1))) THEN
		AGLD=AGLD1
		VRHOV=VRHOV1
	END IF
	IF ((AGLD2.GE.ALP(1,2)).AND.(AGLD2.LE.ALP(IRC,2))) THEN
		AGLD=AGLD2
		VRHOV=VRHOV2
	END IF
	IF ((AGLD2.LE.ALP(1,2)).AND.(AGLD2.GE.ALP(IRC,2))) THEN
		AGLD=AGLD2
		VRHOV=VRHOV2
	END IF
C    2 IF (A.LT.0.D0) GO TO 30
C     LARGE THETA BRANCH
C      CALL RCTPOL(IRD,A,B,VRHOV,AGLD,2)
C      GO TO 36
C     SMALL THETA BRANCH
C   30 CALL RCTPOL(IRD,A,B,VRHOV,AGLD,1)
   36 JJ=4
      IF ((AGLD.GE.ALP(1,1)).AND.(AGLD.LE.ALP(IFC,1))) JJ=1
	IF ((AGLD.LE.ALP(1,1)).AND.(AGLD.GE.ALP(IFC,1))) JJ=1
      IF (JJ.EQ.1) GO TO 10
      IF ((AGLD.GE.ALP(1,2)).AND.(AGLD.LE.ALP(IRC,2))) JJ=2
	IF ((AGLD.LE.ALP(1,2)).AND.(AGLD.GE.ALP(IRC,2))) JJ=2
      IF (JJ.EQ.2) GO TO 10
      IF (NKP.GE.2) THEN
         IF ((ALP(1,3).GE.0.D0).AND.(ALP(NKP,3).GE.0.D0)) THEN
            IF ((AGLD.GE.ALP(1,3)).AND.(AGLD.LE.ALP(NKP,3))) JJ=3
            IF (JJ.EQ.3) GO TO 10
         END IF
         IF ((ALP(1,3).LE.0.D0).AND.(ALP(NKP,3).LE.0.D0)) THEN
            IF ((AGLD.LE.ALP(1,3)).AND.(AGLD.GE.ALP(NKP,3))) JJ=3
            IF (JJ.EQ.3) GO TO 10
         END IF
      END IF         
      ANGLE=AGLD+TWPI
      IF ((ANGLE.GE.ALP(1,1)).AND.(ANGLE.LE.ALP(IFC,1))) JJ=1
      IF (JJ.EQ.1) AGLD=ANGLE
      IF (JJ.EQ.1) GO TO 10
      ANGLE=AGLD-TWPI
      IF ((ANGLE.LE.ALP(1,2)).AND.(ANGLE.GE.ALP(IRC,2))) JJ=2
      IF (JJ.EQ.2) AGLD=ANGLE
      IF (JJ.EQ.2) GO TO 10
      IF ((AGLD.LE.ALP(1,3)).AND.(AGLD.GE.ALP(NKP,3))) JJ=3
      IF (JJ.EQ.3) GO TO 10
      IF ((AGLD.GE.ALP(1,3)).AND.(AGLD.LE.ALP(NKP,3))) JJ=3
      IF (JJ.EQ.3) GO TO 10
      IF ((ANGLE.LE.ALP(1,3)).AND.(ANGLE.GE.ALP(NKP,3))) JJ=3
      IF (JJ.EQ.3) AGLD=ANGLE
      IF (JJ.EQ.3) GO TO 10
      IF ((AGLD.LE.ALP(IRC,2)).AND.(AGLD.GE.ALP(1,3))) JJ=3
      IF (JJ.EQ.3) GO TO 10
   10 GO TO (11,12,13,14) JJ
   11 CALL RHO(AGLD,ARYA,ARYB,ARYC,ALP,RS,1,IRC,IFC,NKP,VRHO)
      GO TO 3      
   12 CALL RHO(AGLD,ARYA,ARYB,ARYC,ALP,RS,2,IRC,IFC,NKP,VRHO)
      GO TO 3
   13 CALL RHO(AGLD,ARYA,ARYB,ARYC,ALP,RS,3,IRC,IFC,NKP,VRHO)
C     The neck cannot cause an eclipse
      IF (VRHO.GT.VRHOV) VRHO=VRHOV-0.00000001D0
      GO TO 3
   14 CALL PMDSTOP
    3 ERVL=VRHOV-VRHO      
   60 RETURN     
      END 
